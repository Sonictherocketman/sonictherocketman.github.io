<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Careful with Complex Querysets - BiteofanApple</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="webmention" href="https://pine.blog/api/webmention/r/f4ecb3b3-6edc-4baa-9553-4f678c3e4b96" />
    <link rel="icon" type="image/png" href="/images/misc/logo-sm.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/misc/favicon.png">

    <link rel="stylesheet" type="text/css" href="/bin/css/stylesheet.css?v=2.2">
    <link rel="stylesheet" type="text/css" href="/bin/css/mobile.css?v=2.2">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml"/>
    <link rel="alternate" type="application/json" title="JSON Feed" href="/feed.json"/>
    
  <meta property="og:title" content="Careful with Complex Querysets" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://brianschrader.com/archive/careful-with-complex-querysets/" />
  

  </head>
  <body>
    <div id="content">
      <div class="nav-container">
  <nav class="nav">
    <div class="nav-item nav-brand">
      <a href="/" class="site-title">
        BiteofanApple
      </a>
      <span
        class="author-tag hide-on-mobile"
      >
        by <a href="/about/">Brian Schrader</a>
      </span>
    </div>
    
    <div class="nav-item"><a href="/archive/">Archive</a></div>
    <div class="nav-item"><a href="/about/">About</a></div>
    <div class="nav-item"><a href="https://skyrocket.software">Apps</a></div>
    <div class="nav-item"><a href="https://mastodon.social/@sonicrocketman">Microblog</a></div>
    
  </nav>
</div>
      
  <div class="bars">
    <div class="main-bar">
      <article class="h-entry">
        <a href="/" class="u-author"></a>
        <div class="post">
          <div class="article-title">
            <h1 class="p-name">
              <a
                href="/archive/careful-with-complex-querysets/"
                title="Careful with Complex Querysets"
              >
                
                Careful With Complex Querysets
                
              </a>
            </h1>
            <small style="font-style:italic;">
              <time class="dt-published" datetime="2020-06-18T18:57:00">
                Posted on Thu, 18 Jun 2020 at 06:57 PM
              </time>
            </small>
          </div>
          <div class="article-content e-content">
            <p>Today I learned something about filtering Django Querysets and fixed a long standing bug. But first some context.</p>
<p>As a feed reader, Pine.blog needs to parse feeds. To do this, every 5 minutes, Pine.blog checks to see which feeds it needs to parse. A feed can fall into one of three categories:</p>
<ul>
<li><strong>Constantly changing feeds with active subscribers</strong>: Feeds that change regularly (i.e. microblogs, Reddit feeds, etc) and have recently active users subscribed to them.</li>
<li><strong>Less frequently changing feeds with active subscribers</strong>: Feeds that may update rarely, but still have recently active users subscribed to them.</li>
<li><strong>Everything else</strong>: Feeds with no one subscribed to them, but are still included in the Feed Directory, or feeds with subscribers who haven't logged in to Pine.blog recently.</li>
</ul>
<p>To do all of this, Pine.blog keeps track of how often a feed is typically updated, but if it can't tell, it sets the <code>approximate_update_frequency</code> to <code>NULL</code>. Then each of the three categories are checked at different frequencies, ensuring that everything gets parsed at least once every 24 hours, but things that change more often, or with active users subscribed to them, are given priority and parsed more regularly: every 15 or every 30 minutes respectively.</p>
<p>It's the second category that's long been acting weird. And that's where my bug comes in.</p>
<h3>The Actual Code</h3>
<p>The bug I discovered has to do with how I group the feeds into those categories. Specifically, I learned that this:</p>
<pre><code>Q(approximate_update_frequency__in=[
    None,
    UpdateFrequency.CONSTANTLY,
    UpdateFrequency.FEW_PER_DAY,
])
</code></pre>
<p>Is not the same as this:</p>
<pre><code>Q(approximate_update_frequency__in=[
    UpdateFrequency.CONSTANTLY,
    UpdateFrequency.FEW_PER_DAY,
]) | Q(approximate_update_frequency__isnull=True)
</code></pre>
<p>The critical change is the switch from including <code>None</code> in the list of allowed items to explicitly filtering by <code>isnull</code>. It seems minor, and it totally feels like you should be able to use None in an <code>IN</code> collection, but you can't.</p>
<p>Funnily enough, the query sort-of works with the <code>None</code> in there, it just ignores the <code>None</code> and uses the other two. The true issue arises when you try to inverse the condition using the <code>NOT</code> operator. This is exactly what Pine.blog's dispatch tasks were doing. It would first fetch the list of every feed matching that criteria, and then do a second fetch of everything that didn't match, and that second one is where results were getting lost.</p>
<p>All this means that some feeds in the second group were being lumped into the third group, delaying their posts from appearing for hours. I've known about this issue for a while, because the posts from this blog (which squarely fall into the second group) weren't showing up in Pine.blog until the following day.</p>
<p>Glad to finally squash that bug.</p>
<div class="footnote">
* This update also migrates Pine.blog to Python 3.7. It's been on 3.6 for years, and I only upgraded it because homebrew screwed up my 3.6 install and it was easier to upgrade Pine.blog than downgrade my Mac's Python version. Fun times.
</div>
          </div>
          <hr />
          <div style="display: flex; justify-content: space-between;">
            <div>
              
              <small>
                Filed under:
                <span class="tags article-content">
                  
                    <a href="/tags.html#tag-django" title="django" class="tag">django</a>,
                  
                    <a href="/tags.html#tag-databases" title="databases" class="tag">databases</a>,
                  
                    <a href="/tags.html#tag-Querysets" title="Querysets" class="tag">Querysets</a>,
                  
                    <a href="/tags.html#tag-cautionary-tale" title="cautionary-tale" class="tag">cautionary-tale</a>
                  
                </span>
              </small><br />
              
              <small>
                Other Links:
                <span class="article-content"><a rel="alternate" href="/rss.xml">RSS Feed</a></span>,
                <span class="article-content"><a rel="alternate" href="/feed.json">JSON Feed</a></span>,
                <span class="article-content">
                  <a
                    rel="status"
                    href="https://nine9s.cloud/s/e/74b2b428-f6b8-4c3f-bf9f-4d4b21404578"
                    target="_blank"
                  >
                    Status Page &#8594;
                  </a>
                </span>
              </small>
            </div>
            <div class="newsletter-callout">
              <div class="callout text-center">
                <a
                  href="https://sendfox.com/brianschrader/"
                  title="Subscribe to the newsletter"
                  class="subscribe"
                  target="_blank"
                >
                  <span class="hide-on-mobile">The</span> Newsletter &#8594;
                </a>
              </div>
            </div>
          </div>
        </div>
      </article>
      <div class="footer">
        <img
          src="/images/misc/logo-sm.png"
          alt="BiteofAnapple Logo"
          style="width: 60px;"
          width="60px"
        />
      </div>
    </div>
    <div class="side-bar">
      <div class="promotion">
  
  <script src="https://shoutouts.page/embed/sRGtA2wwnhW-dAPFXEBy.js" defer></script>
  
</div>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true, baseUrl: "/archive", });
    });
</script>
<h4>Featured Posts</h4>
<ul>
  
  <li><a href="/archive/narrative-structure-and-the-principle-of-least-action/" title="Narrative Structure and the Principle of Least Action" rel="nofollow">
    Narrative Structure and the Principle of Least Action
  </a></li>
  
  <li><a href="/archive/science-models-and-squeaking-lead/" title="Science, Models, and Squeaking Lead" rel="nofollow">
    Science, Models, and Squeaking Lead
  </a></li>
  
  <li><a href="/archive/on-handwriting-and-switching-to-cursive/" title="On Handwriting and Switching to Cursive" rel="nofollow">
    On Handwriting and Switching to Cursive
  </a></li>
  
  <li><a href="/archive/on-the-web-the-best-outcome-is-email/" title="On the Web, the Best Outcome is Email" rel="nofollow">
    On the Web, the Best Outcome is Email
  </a></li>
  
  <li><a href="/archive/the-web-as-a-social-network/" title="The Web as a Social Network" rel="nofollow">
    The Web as a Social Network
  </a></li>
  
</ul>
<h4>Recent Posts</h4>
<ul>
  
  <li><a href="/archive/maintaining-a-music-library-ten-years-on/" title="Maintaining a Music Library, Ten Years On" rel="nofollow">
    Maintaining a Music Library, Ten Years On
  </a></li>
  
  <li><a href="/archive/empirical-partial-derivatives/" title="Empirical Partial Derivatives" rel="nofollow">
    Empirical Partial Derivatives
  </a></li>
  
  <li><a href="/archive/chemical-telescopes-and-the-process-of-science/" title="Chemical Telescopes and the Process of Science" rel="nofollow">
    Chemical Telescopes and the Process of Science
  </a></li>
  
  <li><a href="/archive/pine-blog-deprecation/" title="So Long Pine.blog" rel="nofollow">
    So Long Pine.blog
  </a></li>
  
  <li><a href="/archive/spoken-audio-from-automator--netnewswire/" title="Spoken Audio from Automator &amp; NetNewsWire" rel="nofollow">
    Spoken Audio from Automator &amp; NetNewsWire
  </a></li>
  
  <li><a href="/archive/the-strangely-anthropic-form-of-natural-laws/" title="The Strangely Anthropic Form of Natural Laws" rel="nofollow">
    The Strangely Anthropic Form of Natural Laws
  </a></li>
  
  <li><a href="/archive/your-brain-is-an-l1-cache/" title="Your Brain is an L1 Cache" rel="nofollow">
    Your Brain is an L1 Cache
  </a></li>
  
  <li><a href="/archive/trapped-in-the-infinite-honey-pot/" title="Trapped in the Infinite Honey Pot" rel="nofollow">
    Trapped in the Infinite Honey Pot
  </a></li>
  
  <li><a href="/archive/the-methods-of-science--medieval-rainbows/" title="The Methods of Science &amp; Medieval Rainbows" rel="nofollow">
    The Methods of Science &amp; Medieval Rainbows
  </a></li>
  
  <li><a href="/archive/the-practicals-of-writing-paper-and-pens/" title="The Practicals of Writing: Paper and Pens" rel="nofollow">
    The Practicals of Writing: Paper and Pens
  </a></li>
  
</ul>
<h4>Also Me</h4>
<ul>
  <li><a href="https://mastodon.social/@sonicrocketman" title="Mastodon" rel="nofollow me">
    Mastodon
  </a></li>
  <li><a href="https://github.com/sonictherocketman/" title="GitHub" rel="nofollow me">
    GitHub
  </a></li>
  <li><a href="https://en.gravatar.com/sonicrocketman" title="Gravatar" rel="nofollow me">
    Gravatar
  </a></li>
  <li><a href="https://sonicrocketman.bandcamp.com" title="Bandcamp" rel="nofollow me">
    Bandcamp
  </a></li>
  <li><a href="https://scholar.google.com/citations?user=tQi0VJ0AAAAJ" title="Google Scholar" rel="nofollow me">
    Google Scholar
  </a></li>
  <li><a href="https://www.linkedin.com/in/sonicrocketman/" title="LinkedIn" rel="nofollow me">
    LinkedIn
  </a></li>
</ul>
<h4>Resources</h4>
<ul>
  <li><a href="/archive/bibliography" title="Bibliography">
    Bibliography
  </a></li>
  <li><a href="/archive/bookshelf" title="Book Recommendations">
    Book Recommendations
  </a></li>
  <li><a href="/archive/recipes/" title="Food and Drink Recipes">
    Food &amp; Drink Recipes
  </a></li>
  <li><a href="/archive/reading-report/" title="Reading Report">
    Books & Reading Statistics
  </a></li>
  <li><a href="/archive/drawing-of-the-day/" title="Drawing of the Day">
    Drawing of the Day
  </a></li>
  <li><a href="/archive/daily-step-count--walking-statistics/" title="Daily Step Count &amp; Walking Statistics">
    Daily Step Count &amp; Walking Statistics
  </a></li>
  <li><a href="/tags.html" title="Posts by Tag">
    Tags
  </a></li>
</ul>
<h4>Tags</h4>
<div class="tags">
  
    <a href="/tags.html#tag-programming" title="programming" class="tag">programming</a>,
  
    <a href="/tags.html#tag-software" title="software" class="tag">software</a>,
  
    <a href="/tags.html#tag-software development" title="software development" class="tag">software development</a>,
  
    <a href="/tags.html#tag-pine.blog" title="pine.blog" class="tag">pine.blog</a>,
  
    <a href="/tags.html#tag-blogging" title="blogging" class="tag">blogging</a>,
  
    <a href="/tags.html#tag-open web" title="open web" class="tag">open web</a>,
  
    <a href="/tags.html#tag-history" title="history" class="tag">history</a>,
  
    <a href="/tags.html#tag-development" title="development" class="tag">development</a>,
  
    <a href="/tags.html#tag-writing" title="writing" class="tag">writing</a>,
  
    <a href="/tags.html#tag-python" title="python" class="tag">python</a>
  
</div>
<h4>Blogroll</h4>
<ul>
  <li><a href="https://www.manton.org" title="Manton Reece" rel="nofollow">
    Manton Reece
  </a></li>
  <li><a href="https://acoup.blog" title="A Collection of Unmitigated Pedantry" rel="nofollow">
    A Collection of Unmitigated Pedantry
  </a></li>
  <li><a href="https://aaronparecki.com/" title="Aaron Parecki" rel="nofollow">
    Aaron Parecki
  </a></li>
  <li><a href="https://www.slowboring.com" title="Slow Boring" rel="nofollow">
    Slow Boring
  </a></li>
  <li><a href="https://treyhunner.com" title="Trey Hunner" rel="nofollow">
    Trey Hunner
  </a></li>
  <li><a href="https://www.mnot.net/blog/" title="mark nottingham" rel="nofollow">
    mark nottingham
  </a></li>
  <li><a href="http://globalspin.com" title="Global Spin" rel="nofollow">
    Global Spin
  </a></li>
  <li><a href="https://iifrp.org" title="IIFRP.org" rel="nofollow">
    IIFRP.org
  </a></li>
  <li><a href="http://mattgemmell.com/" title="Matt Gemmell" rel="nofollow">
    Matt Gemmell
  </a></li>
  <li><a href="http://jvns.ca/" title="Julia Evans" rel="nofollow">
    Julia Evans
  </a></li>
  <li><a href="https://www.youtube.com/@SabineHossenfelder" title="Sabine Hossenfelder" rel="nofollow">
    Sabine Hossenfelder
  </a></li>
</ul>
    </div>
  </div>
  <div style="text-align:center;">
    <div class="article-content">
    </div>
  </div>

  <!-- Federation -->
  <a href="https://fed.brid.gy/"></a>

    </div>
  </body>
  <script src="/pagefind/pagefind-ui.js"></script>
</html>